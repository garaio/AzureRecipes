{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1318.3566",
      "templateHash": "15410656405897602923"
    }
  },
  "parameters": {
    "resourceNamePrefix": {
      "type": "string",
      "defaultValue": "customer-project",
      "metadata": {
        "description": "The prefix will be used for every parameter that represents a resource name. See the description of the parameter."
      }
    },
    "resourceNameSuffix": {
      "type": "string",
      "metadata": {
        "description": "The suffix will be appended to every parameter that represents a resource name. See the description of the parameter."
      }
    },
    "resourceLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "keyVaultName": {
      "type": "string"
    },
    "keyVaultResourceGroupName": {
      "type": "string"
    },
    "keyVaultSecretStorageAccountConnectionString": {
      "type": "string",
      "defaultValue": "storageAccountConnectionString"
    },
    "keyVaultSecretServiceBusConnectionString": {
      "type": "string",
      "defaultValue": "serviceBusConnectionString"
    },
    "keyVaultSecretSignalRConnectionString": {
      "type": "string",
      "defaultValue": "signalRConnectionString"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {
    "appServicePlanName": "[format('{0}-asp-{1}', parameters('resourceNamePrefix'), parameters('resourceNameSuffix'))]",
    "appServicePlanSku": {
      "name": "Y1",
      "tier": "Dynamic"
    },
    "serviceFuncName": "[format('{0}-service-f-{1}', parameters('resourceNamePrefix'), parameters('resourceNameSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "pid-d16e7b59-716a-407d-96db-18d1cac40407",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2020-09-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[parameters('resourceLocation')]",
      "sku": "[variables('appServicePlanSku')]",
      "properties": {}
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-03-01",
      "name": "[variables('serviceFuncName')]",
      "location": "[parameters('resourceLocation')]",
      "kind": "functionapp",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[format('{0}.azurewebsites.net', variables('serviceFuncName'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[format('{0}.scm.azurewebsites.net', variables('serviceFuncName'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "clientAffinityEnabled": true,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "siteConfig": {
          "cors": {
            "allowedOrigins": [
              "*"
            ]
          }
        }
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
      ]
    },
    {
      "condition": "[and(not(empty(parameters('keyVaultName'))), not(empty(parameters('keyVaultResourceGroupName'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "func-appsettings",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "serviceFuncName": {
            "value": "[variables('serviceFuncName')]"
          },
          "storageAccountConnectionString": {
            "reference": {
              "keyVault": {
                "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              },
              "secretName": "[parameters('keyVaultSecretStorageAccountConnectionString')]"
            }
          },
          "appInsightsInstrumentationKey": {
            "value": "[parameters('appInsightsInstrumentationKey')]"
          },
          "keyVaultSecretServiceBusConnectionString": {
            "value": "[parameters('keyVaultSecretServiceBusConnectionString')]"
          },
          "keyVaultSecretSignalRConnectionString": {
            "value": "[parameters('keyVaultSecretSignalRConnectionString')]"
          },
          "keyVaultSecretStorageAccountConnectionString": {
            "value": "[parameters('keyVaultSecretStorageAccountConnectionString')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "9947775184844058680"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "serviceFuncName": {
              "type": "string"
            },
            "appInsightsInstrumentationKey": {
              "type": "secureString"
            },
            "storageAccountConnectionString": {
              "type": "secureString"
            },
            "keyVaultSecretStorageAccountConnectionString": {
              "type": "string"
            },
            "keyVaultSecretServiceBusConnectionString": {
              "type": "string"
            },
            "keyVaultSecretSignalRConnectionString": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/{1}', parameters('serviceFuncName'), 'appsettings')]",
              "properties": {
                "AzureWebJobsStorage": "[format('@Microsoft.KeyVault(VaultName={0};SecretName={1})', parameters('keyVaultName'), parameters('keyVaultSecretStorageAccountConnectionString'))]",
                "AzureWebJobsDisableHomepage": "true",
                "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[parameters('storageAccountConnectionString')]",
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[parameters('appInsightsInstrumentationKey')]",
                "FUNCTIONS_EXTENSION_VERSION": "~3",
                "FUNCTIONS_WORKER_RUNTIME": "dotnet",
                "WEBSITE_TIME_ZONE": "W. Europe Standard Time",
                "WEBSITE_CONTENTSHARE": "[parameters('serviceFuncName')]",
                "StorageConnectionString": "[format('@Microsoft.KeyVault(VaultName={0};SecretName={1})', parameters('keyVaultName'), parameters('keyVaultSecretStorageAccountConnectionString'))]",
                "SignalRConnectionString": "[format('@Microsoft.KeyVault(VaultName={0};SecretName={1})', parameters('keyVaultName'), parameters('keyVaultSecretSignalRConnectionString'))]",
                "ServiceBusConncectionString": "[format('@Microsoft.KeyVault(VaultName={0};SecretName={1})', parameters('keyVaultName'), parameters('keyVaultSecretServiceBusConnectionString'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('keyVaultResourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-accesspolicy-service')]"
      ]
    },
    {
      "condition": "[and(not(empty(parameters('keyVaultName'))), not(empty(parameters('keyVaultResourceGroupName'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "keyvault-accesspolicy-service",
      "resourceGroup": "[parameters('keyVaultResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Web/sites', variables('serviceFuncName')), '2021-03-01', 'Full').identity.principalId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "11893719915739478122"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "appPermissions": {
              "type": "object",
              "defaultValue": {
                "keys": [
                  "get"
                ],
                "secrets": [
                  "get"
                ]
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2021-10-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[parameters('principalId')]",
                    "permissions": "[parameters('appPermissions')]"
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('serviceFuncName'))]"
      ]
    }
  ]
}